<!DOCTYPE html>
<html>
<head>
    <title>File Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h3>Welcome, {{ email }}</h3>
        <a href="/logout" class="btn btn-danger">Logout</a>
    </div>

    <form id="uploadForm" enctype="multipart/form-data" class="mb-4">
        <div class="input-group">
            <input type="file" id="fileInput" class="form-control">
            <button type="submit" class="btn btn-primary">Upload</button>
        </div>
    </form>

    <div class="mb-3">
        <strong>Used:</strong> <span id="used"></span> MB / 300 MB
        <div class="progress">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="300">
                0 MB
            </div>
        </div>
    </div>

    <div class="row g-3" id="filesContainer">
        <!-- Files will be dynamically listed here -->
    </div>
</div>

<script>
    const token = localStorage.getItem('firebase_token'); // Assuming the token is stored in localStorage

    if (!token) {
        window.location.href = '/login'; // Redirect to login page if no token
    }

    // Get user data and files
    async function loadUserData() {
        try {
            const res = await fetch('/files', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await res.json();
            if (data.error) {
                alert(data.error);
                return;
            }

            const used = data.storage_used / (1024 * 1024);  // Convert bytes to MB
            const remaining = data.storage_remaining / (1024 * 1024);  // Convert bytes to MB

            document.getElementById('used').innerText = used.toFixed(2);
            document.getElementById('progressBar').style.width = (used / 300) * 100 + '%';
            document.getElementById('progressBar').innerText = `${used.toFixed(2)} MB`;

            const filesContainer = document.getElementById('filesContainer');
            filesContainer.innerHTML = '';

            data.files.forEach(file => {
                const fileCard = document.createElement('div');
                fileCard.classList.add('col-md-6', 'col-lg-4');
                fileCard.innerHTML = `
                    <div class="card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title text-truncate">${file.name}</h6>
                            <a href="${file.url}" class="btn btn-sm btn-success mb-2" download>Download</a>
                            <button class="btn btn-sm btn-outline-secondary mb-2" onclick="copyLink('${file.id}')">Copy Share Link</button>
                            <a href="/delete/${file.id}" class="btn btn-sm btn-danger">Delete</a>
                        </div>
                    </div>
                `;
                filesContainer.appendChild(fileCard);
            });
        } catch (err) {
            console.error('Error loading files:', err);
        }
    }

    loadUserData();

    document.getElementById('uploadForm').addEventListener('submit', async (event) => {
        event.preventDefault();

        const fileInput = document.getElementById('fileInput');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const res = await fetch('/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            const data = await res.json();
            if (data.error) {
                alert(data.error);
                return;
            }

            alert('File uploaded successfully');
            loadUserData(); // Reload the file list after upload
        } catch (err) {
            console.error('Error uploading file:', err);
        }
    });

    function copyLink(fileId) {
        const link = `${window.location.origin}/download/${fileId}`;
        navigator.clipboard.writeText(link).then(() => {
            alert("Link copied to clipboard!");
        });
    }
</script>

</body>
</html>
