<!DOCTYPE html>
<html>
<head>
    <title>File Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h3>Welcome</h3>
        <button onclick="logout()" class="btn btn-danger">Logout</button>
    </div>

    <form id="uploadForm" enctype="multipart/form-data" method="POST">
        <div class="input-group">
            <input type="file" id="fileInput" name="file" class="form-control">
            <button type="submit" class="btn btn-primary">Upload</button>
        </div>
    </form>

    <div class="mb-3">
        <strong>Used: </strong><span id="used"></span> MB / 300 MB
        <div class="progress">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="300">
                0 MB
            </div>
        </div>
    </div>

    <div id="filesContainer">
        <!-- Files will appear here -->
    </div>
</div>

<script>
    // Assuming you stored the Firebase token in localStorage
    const token = localStorage.getItem('firebase_token'); 

    if (!token) {
        window.location.href = '/login'; // Redirect to login if no token
    }

    // Load user's files and storage usage
    async function loadUserData() {
        try {
            const res = await fetch('/files', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            const used = data.storage_used / (1024 * 1024); // Convert to MB
            const remaining = data.storage_remaining / (1024 * 1024); // Convert to MB

            document.getElementById('used').innerText = used.toFixed(2);
            document.getElementById('progressBar').style.width = (used / 300) * 100 + '%';
            document.getElementById('progressBar').innerText = `${used.toFixed(2)} MB`;

            // Display files
            const filesContainer = document.getElementById('filesContainer');
            filesContainer.innerHTML = '';
            data.files.forEach(file => {
                const fileCard = document.createElement('div');
                fileCard.classList.add('card', 'mb-2');
                fileCard.innerHTML = `
                    <div class="card-body">
                        <h6>${file.name}</h6>
                        <a href="${file.url}" class="btn btn-success" download>Download</a>
                    </div>
                `;
                filesContainer.appendChild(fileCard);
            });
        } catch (err) {
            console.error('Error loading files:', err);
        }
    }

    loadUserData();

    document.getElementById('uploadForm').addEventListener('submit', async (event) => {
        event.preventDefault();

        const fileInput = document.getElementById('fileInput');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const res = await fetch('/upload', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            const data = await res.json();
            if (data.error) {
                alert(data.error);
                return;
            }

            alert('File uploaded successfully');
            loadUserData(); // Reload the file list
        } catch (err) {
            console.error('Error uploading file:', err);
        }
    });

    function logout() {
        localStorage.removeItem('firebase_token');
        window.location.href = '/login'; // Redirect to login page
    }
</script>

</body>
</html>
